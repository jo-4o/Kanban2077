<div class="kanban-container">
  <header class="kanban-header">
    <h1 data-text="📋 Kanban Board">📋 Kanban Board</h1>
    <div style="display: flex; gap: 12px;">
      <button class="add-task-btn" (click)="openAddTaskModal()" [disabled]="loading">
        <span *ngIf="loading">⏳ Carregando...</span>
        <span *ngIf="!loading">+ Nova Tarefa</span>
      </button>
      <button class="add-task-btn" (click)="openAddColumnModal()" [disabled]="loading">
        <span *ngIf="!loading">+ Novo Quadro</span>
      </button>
    </div>
<!-- Modal para adicionar novo quadro/coluna -->
<div class="modal-overlay" *ngIf="showAddColumnModal" (click)="closeAddColumnModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Novo Quadro</h3>
    <form (ngSubmit)="addColumn()" #columnForm="ngForm">
      <div class="form-group">
        <label>Nome do Quadro</label>
        <input type="text" [(ngModel)]="newColumnTitle" name="columnTitle" required>
      </div>
      <div class="modal-actions">
        <button type="button" (click)="closeAddColumnModal()">Cancelar</button>
        <button type="submit" [disabled]="!columnForm.valid">Criar Quadro</button>
      </div>
    </form>
  </div>
</div>
  </header>

  <!-- Indicador de erro -->
  <div class="error-message" *ngIf="error">
    <div class="message-text">⚠️ {{ error }}</div>
    <button class="close-error" (click)="animateCloseError($event)">X</button>
  </div>

  <!-- Indicador de loading -->
  <div class="loading-indicator" *ngIf="loading">
    <div class="spinner"></div>
    <p>Carregando tarefas...</p>
  </div>

  <div class="kanban-board" 
       cdkDropList 
       cdkDropListOrientation="horizontal"
       [cdkDropListData]="columns"
       (cdkDropListDropped)="dropColumn($event)">
    <div class="kanban-column" 
         *ngFor="let column of columns"
         cdkDrag
         (contextmenu)="openColumnContextMenu($event, column)">
      <div class="column-header" cdkDragHandle>
        <h3>{{ column.title }}</h3>
        <span class="task-count">{{ getTaskCount(column.id) }}</span>
        <div class="drag-handle">⋮⋮</div>
      </div>
      
      <div class="tasks-container" 
           cdkDropList 
           [id]="'column-' + column.id"
           [cdkDropListData]="getTasksByColumn(column.id)"
           (cdkDropListDropped)="drop($event)"
           [cdkDropListConnectedTo]="getConnectedColumns(column.id)">
        
        <div class="task-card" 
             *ngFor="let task of getTasksByColumn(column.id)"
             cdkDrag>
          <div class="task-header">
            <span class="task-priority priority-{{ task.priority }}">{{ task.priority }}</span>
            <button class="task-menu" (click)="openTaskMenu(task)">⋮</button>
          </div>
          
          <h4 class="task-title">{{ task.title }}</h4>
          <p class="task-description">{{ task.description }}</p>
          
          <div class="task-footer">
            <span class="task-assignee">{{ task.assignee }}</span>
            <span class="task-date">{{ task.dueDate | date:'dd/MM' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para adicionar nova tarefa -->
<div class="modal-overlay" *ngIf="showAddTaskModal" (click)="closeAddTaskModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Nova Tarefa</h3>
    <form (ngSubmit)="addTask()" #taskForm="ngForm">
      <div class="form-group">
        <label>Título</label>
        <input type="text" [(ngModel)]="newTask.title" name="title" required>
      </div>
      
      <div class="form-group">
        <label>Descrição</label>
        <textarea [(ngModel)]="newTask.description" name="description"></textarea>
      </div>
      
      <div class="form-group">
        <label>Responsável</label>
        <input type="text" [(ngModel)]="newTask.assignee" name="assignee">
      </div>
      
      <div class="form-group">
        <label>Prioridade</label>
        <select [(ngModel)]="newTask.priority" name="priority">
          <option value="baixa">Baixa</option>
          <option value="media">Média</option>
          <option value="alta">Alta</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Quadro</label>
        <select [(ngModel)]="newTask.columnId" name="columnId">
          <option *ngFor="let column of columns" [value]="column.id">
            {{ column.title }}
          </option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Data de Entrega</label>
        <input type="date" [(ngModel)]="newTask.dueDate" name="dueDate">
      </div>
      
      <div class="modal-actions">
        <button type="button" (click)="closeAddTaskModal()">Cancelar</button>
        <button type="submit" [disabled]="!taskForm.valid">Criar Tarefa</button>
      </div>
    </form>
  </div>
</div>

<!-- Context Menu para colunas -->
<div class="context-menu" 
     *ngIf="showColumnContextMenu"
     [style.left.px]="contextMenuPosition.x"
     [style.top.px]="contextMenuPosition.y">
  <div class="context-menu-item" (click)="editColumn()">
    <span class="context-menu-icon">✏️</span>
    Editar
  </div>
  <div class="context-menu-item" (click)="duplicateColumn()">
    <span class="context-menu-icon">📋</span>
    Duplicar
  </div>
  <div class="context-menu-separator"></div>
  <div class="context-menu-item context-menu-item-danger" (click)="deleteColumn()">
    <span class="context-menu-icon">🗑️</span>
    Excluir
  </div>
</div>

<!-- Modal para editar coluna -->
<div class="modal-overlay" *ngIf="showEditColumnModal" (click)="showEditColumnModal = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>Editar Quadro</h3>
    <form (ngSubmit)="updateColumn()" #editColumnForm="ngForm">
      <div class="form-group">
        <label>Nome do Quadro</label>
        <input type="text" [(ngModel)]="editingColumnTitle" name="editColumnTitle" required>
      </div>
      <div class="modal-actions">
        <button type="button" (click)="showEditColumnModal = false">Cancelar</button>
        <button type="submit" [disabled]="!editColumnForm.valid">Salvar</button>
      </div>
    </form>
  </div>
</div>